#!/usr/bin/env bash

OPTIONS="$@"
SCRIPTPATH="$0"

set -e pipefail
shopt -s extglob
shopt -s globstar
shopt -s dotglob

function chownit {
  sudo chown "$1" /etc/nixos/
  sudo chown "$1" /etc/nixos/**/
  sudo chown "$1" /etc/nixos/**
  echo "Chowned /etc/nixos/ as $1"
}

function to-user {
  chownit "$USER"
}
function to-root {
  chownit root
}
function usage {
  echo "$SCRIPTPATH [q]uery  -- queries owner of /etc/nixos"
  echo "$SCRIPTPATH [u]ser   -- chowns /etc/nixos as \$USER"
  echo "$SCRIPTPATH [r]oot   -- chowns /etc/nixos as root"
  echo "$SCRIPTPATH [t]oggle -- toogles chown between root and \$USER"
}

OWNER="$(stat -c '%U' /etc/nixos/configuration.nix)"
if [[ "$OPTIONS" == q* ]]; then # query
  echo "$OWNER"
elif [[ "$OPTIONS" == u* ]]; then # user
  to-user
elif [[ "$OPTIONS" == r* ]]; then # root
  to-root
elif [[ "$OPTIONS" == t* ]]; then # toggle
  [[ "$OWNER" == 'root' ]] && to-user || to-root
else
  usage
fi
